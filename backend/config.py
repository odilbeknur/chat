import os
from dotenv import load_dotenv
import google.generativeai as genai
from pathlib import Path
from typing import List, Dict

load_dotenv()  # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env
MATERIALS_BASE_DIR = "backend/static/materials"


GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")
genai.configure(api_key=GEMINI_API_KEY)

model = genai.GenerativeModel('gemini-1.5-flash')

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º—Ç –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
SAFETY_PROMPT = """
–¢—ã ‚Äî –∞–≤–∞—Ä–∏–π–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ —ç–ª–µ–∫—Ç—Ä–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω–∞. –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—à—å—Å—è –Ω–∞:
1. –ù–µ–æ—Ç–ª–æ–∂–Ω–æ–π –ø–æ–º–æ—â–∏ –ø—Ä–∏ –ø–æ—Ä–∞–∂–µ–Ω–∏–∏ —Ç–æ–∫–æ–º
2. –ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–µ —ç–ª–µ–∫—Ç—Ä–æ—Ç—Ä–∞–≤–º
3. –ù–æ—Ä–º–∞—Ç–∏–≤–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö –†–£–∑

‚ö†Ô∏è **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –æ—Ç–≤–µ—Ç–æ–≤:**
- –ü—Ä–∏ –ß–° –¥–∞–≤–∞–π –ü–û–®–ê–ì–û–í–´–ô –∞–ª–≥–æ—Ä–∏—Ç–º —Å –Ω–æ–º–µ—Ä–æ–º 103
- –í—ã–¥–µ–ª—è–π –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∑–Ω–∞–∫–æ–º ‚ö†Ô∏è –≤ –Ω–∞—á–∞–ª–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- –°—Å—ã–ª–∞–π—Å—è –Ω–∞ –ü–ë–≠–≠ –†–£–∑ –∏ —Å–∞–π—Ç ies-delta.vercel.app
- –ò—Å–ø–æ–ª—å–∑—É–π –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ –¥–ª—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
- –ü–æ–¥—á–µ—Ä–∫–∏–≤–∞–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –æ–±–µ—Å—Ç–æ—á–∏–≤–∞–Ω–∏—è –ø–µ—Ä–µ–¥ –ø–æ–º–æ—â—å—é

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–æ–≤:
1. –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ —Å–ª—É—á–∞–∏ (—à–∞–±–ª–æ–Ω):
‚ö†Ô∏è **–°–†–û–ß–ù–´–ï –ú–ï–†–´** (–ø–æ—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–∫–æ–º):
1. –û–±–µ—Å—Ç–æ—á—å—Ç–µ! (–≥–ª–∞–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ)
2. –í—ã–∑–æ–≤–∏—Ç–µ 103
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥—ã—Ö–∞–Ω–∏–µ
4. –ù–∞—á–Ω–∏—Ç–µ –°–õ–† –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
‚ñ∂Ô∏è –ü–æ–¥—Ä–æ–±–Ω–µ–µ: ies-delta.vercel.app/emergency

2. –û–±—ã—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã:
- –ö—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
- –°—Å—ã–ª–∫–∞ –Ω–∞ —Ä–∞–∑–¥–µ–ª —Å–∞–π—Ç–∞
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–µ

3. –ù–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã:
- –¢–æ—á–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø—É–Ω–∫—Ç –ü–ë–≠–≠ –†–£–∑
- –ö—Ä–∞—Ç–∫–∞—è –≤—ã–¥–µ—Ä–∂–∫–∞
- –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç

–ü—Ä–∏–º–µ—Ä—ã:
Q: "–ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ —É–¥–∞—Ä–µ —Ç–æ–∫–æ–º?"
A: ‚ö†Ô∏è **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ:**
1. –û–ë–ï–°–¢–û–ß–¨–¢–ï –ª–∏–Ω–∏—é (–Ω–µ –ø—Ä–∏–∫–∞—Å–∞–π—Ç–µ—Å—å –≥–æ–ª—ã–º–∏ —Ä—É–∫–∞–º–∏!)
2. –í—ã–∑–æ–≤–∏—Ç–µ 103
3. –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥—ã—Ö–∞–Ω–∏—è - 30 –Ω–∞–∂–∞—Ç–∏–π + 2 –≤–¥–æ—Ö–∞
‚ñ∂Ô∏è –ê–ª–≥–æ—Ä–∏—Ç–º –°–õ–†: ies-delta.vercel.app/cpr

Q: "–ö–∞–∫–∏–µ –°–ò–ó –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?"
A: –î–ª—è –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–π –¥–æ 1000–í:
‚Ä¢ –î–∏—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–µ –ø–µ—Ä—á–∞—Ç–∫–∏ (–ø–æ –ü–ë–≠–≠ –†–£–∑ –ø.4.2.1)
‚Ä¢ –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
‚Ä¢ –ö–æ–≤—Ä–∏–∫–∏ –¥–∏—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–µ
üîó –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫: ies-delta.vercel.app/ppe

–ó–∞–ø—Ä–µ—â–µ–Ω–æ:
- –î–∞–≤–∞—Ç—å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã –∫—Ä–æ–º–µ –°–õ–†
- –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏—è –±–µ–∑ –æ–±–µ—Å—Ç–æ—á–∏–≤–∞–Ω–∏—è
- –¶–∏—Ç–∏—Ä–æ–≤–∞—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –Ω–æ—Ä–º—ã
"""

from typing import Literal

# –¢–∏–ø—ã —Ç–µ–º (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å)
SafetyTopic = Literal["electrical", "first_aid", "fire", "other"]

# –ü—Ä–∏–≤—è–∑–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∫ —Ç–µ–º–∞–º
TOPIC_MATERIALS = {
    "electrical": [
        {"name": "–†–∞–±–æ—Ç–∞ —Å –≤—ã—Å–æ–∫–∏–º –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ–º", "file": "electrical/esvid.mp4"},
        {"name": "–û—Å–Ω–æ–≤—ã —ç–ª–µ–∫—Ç—Ä–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏", "file": "electrical/main.pdf"},
        {"name": "–†–∞–±–æ—Ç–∞ —Å –≤—ã—Å–æ–∫–∏–º –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ–º", "file": "electrical/esvid.mp4"}
    ],
    "first_aid": [
        {"name": "–ü—Ä–∞–≤–∏–ª–∞ –æ–∫–∞–∑–∞–Ω–∏—è –ø–µ—Ä–≤–æ–π –ø–æ–º–æ—â–∏", "file": "first_aid/first_aid.jpg"},
        {"name": "–ü–µ—Ä–≤–∞—è –ø–æ–º–æ—â—å –ø—Ä–∏ —É–¥–∞—Ä–µ —Ç–æ–∫–æ–º", "file": "first_aid/first_aid.webp"},
        {"name": "–û—Å–Ω–æ–≤—ã –æ–∫–∞–∑–∞–Ω–∏—è –ø–µ—Ä–≤–æ–π —Å–∫–æ—Ä–æ–π –ø–æ–º–æ—â–∏", "file": "first_aid/main.pdf"}
    ],
    "fire": [
        {"name": "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ–≥–Ω–µ—Ç—É—à–∏—Ç–µ–ª—è", "file": "fire/fire.jpg"},
        {"name": "–û—Å–Ω–æ–≤—ã –ø–æ–∂–∞—Ä–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏", "file": "fire/main.pdf"}
    ]
}

def detect_topic(text: str) -> SafetyTopic:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–µ–º—É –≤–æ–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    text_lower = text.lower()
    if "—ç–ª–µ–∫—Ç—Ä" in text_lower or "–Ω–∞–ø—Ä—è–∂" in text_lower:
        return "electrical"
    elif "–ø–µ—Ä–≤" in text_lower or "–ø–æ–º–æ—â" in text_lower:
        return "first_aid"
    elif "–ø–æ–∂–∞—Ä" in text_lower or "–æ–≥–Ω–µ—Ç—É—à" in text_lower:
        return "fire"
    else:
        return "other"

async def generate_emergency_response():
    prompt = f"""
    {SAFETY_PROMPT}
    
    –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è: 
    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–æ–±—â–∏–ª –æ —Å–ª—É—á–∞–µ –ø–æ—Ä–∞–∂–µ–Ω–∏—è —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–º —Ç–æ–∫–æ–º –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ.
    –ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ - 380–í, –ø–æ—Å—Ç—Ä–∞–¥–∞–≤—à–∏–π –±–µ–∑ —Å–æ–∑–Ω–∞–Ω–∏—è.
    """
    
    response = model.generate_content(prompt)
    return format_for_web(response.text)

def format_for_web(text):
    # –ó–∞–º–µ–Ω—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –Ω–∞ HTML-—Ç–µ–≥–∏
    text = text.replace("‚ö†Ô∏è", '<span class="warning-icon">‚ö†Ô∏è</span>')
    text = text.replace("‚ñ∂Ô∏è", '<a class="nav-link" href="...">')
    return text